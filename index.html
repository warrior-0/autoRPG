<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìë™ì‚¬ëƒ¥ RPG</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { font-family: Arial; text-align: center; background: #f5f5f5; padding: 30px; }
    button { margin: 5px; padding: 10px 20px; }
    #log { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; background: #fff; padding: 10px; margin-top: 20px; }
    #gameUI { display: none; }
  </style>
</head>
<body>
  <h1>ìë™ì‚¬ëƒ¥ RPG</h1>

  <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… UI -->
  <div id="authUI">
    <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„" /><br />
    <input type="email" id="email" placeholder="ì´ë©”ì¼" /><br />
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" /><br />
    <button onclick="signUp()">íšŒì›ê°€ì…</button>
    <button onclick="signIn()">ë¡œê·¸ì¸</button>
  </div>

  <!-- ê²Œì„ UI -->
  <div id="gameUI">
    <p><strong>í˜„ì¬ ìœ ì €:</strong> <span id="nicknameDisplay"></span></p>
    <p>ê³¨ë“œ: <span id="gold">0</span> | ê²½í—˜ì¹˜: <span id="exp">0</span> | ë˜ì „ ì‹œê°„: <span id="dungeonTime">60</span>ì´ˆ</p>
    <button onclick="enterDungeon()">ë˜ì „ ì…ì¥</button>
    <button onclick="signOut()">ë¡œê·¸ì•„ì›ƒ</button>
    <div id="log"></div>
  </div>

  <script>
    let userData = {};
    let inDungeon = false;
    let dungeonInterval;

    function log(message) {
      const logDiv = document.getElementById("log");
      logDiv.innerHTML = `<div>> ${message}</div>` + logDiv.innerHTML;
    }

    function updateUI() {
      document.getElementById("gold").innerText = userData.gold;
      document.getElementById("exp").innerText = userData.exp;
      document.getElementById("dungeonTime").innerText = userData.dungeonTime;
    }

    function saveData() {
      const user = auth.currentUser;
      if (user) {
        db.collection("users").doc(user.uid).set(userData, { merge: true });
      }
    }

    function loadData() {
      const user = auth.currentUser;
      if (user) {
        db.collection("users").doc(user.uid).get().then(doc => {
          if (doc.exists) {
            userData = doc.data();
            document.getElementById("nicknameDisplay").innerText = userData.nickname || user.email;
            updateUI();
          }
        });
      }
    }

    function startAutoHunt() {
      setInterval(() => {
        if (!inDungeon) {
          userData.gold += 10;
          userData.exp += 5;
          log("ëª¬ìŠ¤í„° ì²˜ì¹˜! ê³¨ë“œ +10, ê²½í—˜ì¹˜ +5");
          updateUI();
          saveData();
        }
      }, 1000);
    }

    function enterDungeon() {
      if (inDungeon || userData.dungeonTime <= 0) {
        alert("ë˜ì „ì— ì…ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      inDungeon = true;
      log("ë˜ì „ì— ì…ì¥í•©ë‹ˆë‹¤!");
      dungeonInterval = setInterval(() => {
        userData.dungeonTime--;
        userData.gold += 50;
        userData.exp += 20;
        log("ë˜ì „ ëª¬ìŠ¤í„° ì²˜ì¹˜! ê³¨ë“œ +50, ê²½í—˜ì¹˜ +20");
        updateUI();
        saveData();
        if (userData.dungeonTime <= 0) {
          clearInterval(dungeonInterval);
          inDungeon = false;
          log("ë˜ì „ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
      }, 1000);
    }

    // ğŸ”¹ ë‹‰ë„¤ì„ ì¤‘ë³µ ê²€ì‚¬ í›„ íšŒì›ê°€ì…
    async function signUp() {
      const email = document.getElementById("email").value;
      const pw = document.getElementById("password").value;
      const nickname = document.getElementById("nicknameInput").value;

      if (!nickname || !email || !pw) {
        alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      // ë‹‰ë„¤ì„ ì¤‘ë³µ ê²€ì‚¬
      const snapshot = await db.collection("users").where("nickname", "==", nickname).get();
      if (!snapshot.empty) {
        alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ë‹‰ë„¤ì„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
        return;
      }

      auth.createUserWithEmailAndPassword(email, pw)
        .then(cred => {
          const uid = cred.user.uid;
          return db.collection("users").doc(uid).set({
            nickname: nickname,
            gold: 0,
            exp: 0,
            dungeonTime: 60
          });
        })
        .then(() => {
          alert("íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
        })
        .catch(err => {
          // ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì¸ ê²½ìš° ì´ëŸ° ì—ëŸ¬ì½”ë“œ ë°œìƒ
          if (err.code === 'auth/email-already-in-use') {
            alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
          }
        });
    }

    function signIn() {
      const email = document.getElementById("email").value;
      const pw = document.getElementById("password").value;
      auth.signInWithEmailAndPassword(email, pw)
        .then(() => {
          document.getElementById("authUI").style.display = "none";
          document.getElementById("gameUI").style.display = "block";
          loadData();
          startAutoHunt();
        })
        .catch(err => alert(err.message));
    }

    function signOut() {
      auth.signOut().then(() => {
        location.reload();
      });
    }
  </script>
</body>
</html>
